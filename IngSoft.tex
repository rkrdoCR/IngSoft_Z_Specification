\documentclass[12pt,a4paper]{article}
\usepackage{zed-csp}
\usepackage{graphicx}
\graphicspath{{images/}}
\usepackage[utf8]{inputenc}
\usepackage[spanish]{babel}
\usepackage{float}
\usepackage{fancyhdr}
\usepackage{tikz}
\usetikzlibrary{shapes,arrows}
\usetikzlibrary{matrix}

\tikzstyle{line} = [draw, -latex']

\usetikzlibrary{arrows.meta,
                calc, chains,
                quotes,
                positioning,
                shapes.geometric}               

\usepackage[nottoc]{tocbibind} %Adds "References" to the table of contents
\usepackage{url}

%% Comandos
\renewcommand{\familydefault}{\rmdefault}
\renewcommand*{\defs}{\mathrel{\widehat{=}}}

\title{Entrega de paquetes. Bodegaje y entrega al comprador.\\Especificación en Z.}
%%

\pagestyle{fancy}
\fancyhead[LE,RO]{Entrega de paquetes. Bodegaje y entrega al comprador.}
\fancyhead[RE,LO]{}

\newcommand{\myBox}[3]{%	
	\begin{tcolorbox}[colback=#1,colframe=#2]
		\centering{#3}
	\end{tcolorbox}
}
 
%
\begin{document}


\begin{titlepage}
	\centering
	\includegraphics[width=0.33\textwidth]{Teclogocompleto.jpg}\par\vspace{1cm}
	{\scshape\large \textbf{Instituto Tecnológico de Costa Rica }\par}
	\vspace{1cm}
	{\scshape\Large MC 7204 Ingeniería de Software\par}
	\vspace{1.5cm}
	{\Large\bfseries 
	Entrega de paquetes.\\Bodegaje y entrega al comprador.\\Especificación en Z.\par}
	\vspace{2cm}
	{\Large\itshape Marco Acuña  \\
	 Ricardo Alfaro\par}
	\vfill
	Profesor:\par
	Ignacio Trejos Zelaya\textsc{}
	\vfill

% Bottom of the page
	{\large} Noviembre 2020 \par
\end{titlepage}

\tableofcontents
\newpage


\section{Resumen}
El comercio ha sido una actividad fundamental en la historia de la humanidad y como tal ha evolucionado de acuerdo a las tecnologías disponibles en las diferentes épocas. 
En el mundo actual se pueden observar fácilmente dos ejes principales en el establecimiento de las relaciones comerciales: 
\begin{enumerate}
\item La comodidad y seguridad que brindan los medios electrónicos de pago para adquirir productos en el exterior a través de sitios web de tipo comercio electrónico (e-commerce)
\item El traslado de los bienes adquiridos que realizan las empresas de logística y mensajería apoyadas también en los beneficios tecnológicos actuales, tanto a nivel de transporte como de información.
\end{enumerate}
Presentamos un trabajo de especificación formal enfocado en modelar parte del proceso que contempla el eje mencionado anteriormente en el punto numero 2. En la siguiente lista se resume un flujo común (hoy en día) de adquisición y entrega de un paquete:
\begin{enumerate}
\item La persona que desea adquirir un producto cuenta con lo siguiente:
\begin{enumerate}
\item Una cuenta con alguna empresa de logística y mensajería a nivel nacional.
\item Algún medio de pago electrónico que le permita hacer compras en el extranjero.
\end{enumerate}
\item El comprador adquiere uno o varios productos en un sitio de comercio electrónico.
\item El comprador envía los productos adquiridos al casillero que le fue asignado por parte de la empresa de logística y mensajería.
\item La empresa de logística y mensajería procesa el paquete recibido y lo asigna a una carga y a un vuelo que lo traerá al país.
\item Una vez en el país el paquete es procesado por aduanas para lo referente a tramites de nacionalización.
\item La empresa de logística y mensajería mueve el paquete a sus bodegas en el pais para proseguir con lo referente a la entrega del paquete al comprador.
\item El flujo finaliza cuando el comprador ha recibido el paquete.
\end{enumerate}

\section{Definición del problema}
La entrega pronta y precisa de los paquetes adquiridos mediante compras en el exterior. Se toma en cuenta la parte del proceso que inicia luego de que el paquete ha sido procesado por la aduana (tramites de nacionalización).
\subsection{Bodegaje y entrega al comprador.}
Para efectos de este trabajo se denomina dicho subproceso como \textit{Bodegaje y entrega al comprador} y los pasos que comprende son:
\begin{enumerate}
\item El paquete existe en la bodega de la empresa de mensajería y no esta asignado a alguna ruta para su entrega al comprador.
\item El paquete es retirado de la bodega, es asignado a un mensajero y puesto en ruta.
\item El mensajero intenta la entrega del paquete, acá se pueden presentar los siguientes escenarios:
\begin{enumerate}
\item El comprador esta disponible en la dirección de entrega y recibe el paquete.
\item El comprador no se encuentra en la dirección de entrega, por lo que el paquete debe ser devuelto de nuevo a la bodega.
\end{enumerate}
\item Si el paquete no fue recibido por el comprador, el mismo debe volver a ser ingresado a la bodega, lo cual permite que el paquete este disponible de nuevo para reiniciar el proceso de entrega.
\end{enumerate}

Para cada etapa del proceso descrita en este apartado, el sistema genera un registro en el historial de rastreo del paquete. Este registro es simplemente una entrada de datos asociada a un tipo de movimiento que refleja el estado actual del paquete. El manejo del histórico de movimientos del paquete no esta incluido dentro del alcance de este trabajo, sin embargo, se incluye la figura 1 con el objetivo de brindar una intuición de la posible estructura de un registro de movimiento en el historial. 

\tikzset{ 
    table/.style={
        matrix of nodes,
        row sep=-\pgflinewidth,
        column sep=-\pgflinewidth,
        nodes={
            rectangle,
            draw=black,
            align=center
        },
        minimum height=1.5em,
        text depth=0.5ex,
        text height=2ex,
        nodes in empty cells,
%%
        every even row/.style={
            nodes={fill=gray!20}
        },
        column 1/.style={
            nodes={text width=2em,font=\bfseries}
        },
        row 1/.style={
            nodes={
                fill=green!30,
                text=black,
                font=\bfseries
            }
        }
    }
}

\begin{figure}[h]
\centering
\begin{tikzpicture}
\matrix (first) [table,text width=6em]
{
  Id  & IdPaq & FechaHora  &  TipoMov  & IdEmp & Notas\\
  1   & 10023 & dd/mm/yyyy &  enRuta   & E012  & en ruta \\
};
\end{tikzpicture}
\caption{\textit{Registro de evento.}} \label{fig:M1}
\end{figure}

\subsection{Diagrama de flujo del subproceso.}
El siguiente diagrama de flujo ilustra la parte del proceso que sera formalizada en este trabajo, los registros del historial son generados en los procesos.

\begin{figure}[h]
\centering
\begin{tikzpicture}[
    node distance=1.69cm,
    startstop/.style={rectangle, rounded corners, minimum width=3cm, minimum height=1cm,text centered, draw=black, fill=red!30},
    process/.style={rectangle, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=orange!30},
    io/.style={trapezium, trapezium left angle=70, trapezium right angle=110, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=blue!30},
    decision/.style={diamond, minimum width=3cm, minimum height=1cm, text centered, draw=black, fill=green!30},
    ]

    \node (node0) [startstop]                             					{Inicio};
    \node (node1) [process, align=center, below of=node0]               	{Paquete esta\\en bodega};
    \node (node2) [decision, align=center, below of=node1,yshift=-1cm]		{Asignable?};     
    \node (node3) [process, align=center, below of=node2, yshift=-1cm] 		{Asignar ruta,\\mensajero y enviar};
    \node (node4) [process, align=center, right of=node2, xshift=4.5cm]   	{Mantener\\en bodega};
    \node (node5) [decision, align=center, below of=node3, yshift=-1cm]		{Entregado?};
    \node (node6) [process, align=center, below of=node5, yshift=-1cm]		{Registrar\\entrega};
    \node (node7) [process, align=center, right of=node5, xshift=2cm]   	{Devolver\\a bodega};
    \node (node8) [startstop, below of=node6, xshift=3.7cm]					{Fin};

    \draw [arrows=-Stealth] (node0) --node[anchor=east]             {}		(node1);
    \draw [arrows=-Stealth] (node1) --node[anchor=east]             {}		(node2);
    \draw [arrows=-Stealth] (node2) --node[anchor=east]             {si}	(node3);
    \draw [arrows=-Stealth] (node2) --node[anchor=south]            {no}    (node4);
    \draw [arrows=-Stealth] (node3) --node[anchor=south]            {}		(node5);
    \draw [arrows=-Stealth] (node5) --node[anchor=east]             {si}	(node6);
    \draw [arrows=-Stealth] (node5) --node[anchor=south]            {no}    (node7);
    \path [line, arrows=-Stealth] (node4) |- (node8);
    \path [line, arrows=-Stealth] (node7) -- (node8);    
    \path [line, arrows=-Stealth] (node6) |- (node8);

  \end{tikzpicture}
\caption{\textit{Flujo. Bodegaje y entrega al comprador}} \label{fig:M1}
\end{figure}


\newpage
\section{Especificación en Z}

Se presenta una especificación formal en Z para el subproceso denominado en este trabajo como \textit{Bodegaje y entrega al comprador} el cual es parte de un sistema de manejo y entrega de paquetes cuya finalidad es de que sea utilizado por empresas de servicios logística y de mensajería.  

\subsection{Variables globales}
Se definen los tipos \textit{Paquete} y \textit{Persona}  como los conjuntos(tipos) que se utilizan en esta especificación. 

\begin{zed}
~~~~~~~~~~~~~~~~~~~~~~~~[Paquete,~Cliente,~Empleado]
\end{zed}

\subsection{Respuestas del sistema}

Cada operación del sistema debe reportar su resultado mediante un mensaje de respuesta que informe al usuario acerca del estado actual del proceso.

\begin{zed}
Respuesta~~::=~~OK\\
~~~~~~|~~paqueteDisponibleParaEntrega\\
~~~~~~|~~paqueteDesalmacenadoAsignado\\
~~~~~~|~~paqueteEntregadoAComprador\\
~~~~~~|~~compradorNoDisponibleParaEntrega\\
\end{zed}

\subsection{Disponibilidad y asignación de mensajeros}
\indent Para cumplir con el objetivo de que los paquetes lleguen a sus dueños es fundamental la participación de los mensajeros. Con el fin de garantizar un manejo adecuado de la disponibilidad y asignación de de los mensajeros se presenta la siguiente definición libre de tipos:

\begin{zed}
ASIGNA~~::=~~asignaOK~|~asignaFallido
\end{zed}

Esta definición permite crear esquemas que brindan una respuesta robusta a los posibles resultados de la acción de asignar paquetes a un mensajero:
\begin{itemize}
\item Hay un mensajero disponible y es posible asignar el paquete.
\begin{schema}{MensajeroDisponible}
resultado! : ASIGNA
\where
resultado! = asignaOK
\end{schema}

\item No hay mensajeros disponibles para la ruta de entrega del paquete.
\begin{schema}{MensajeroNoDisponible}
resultado! : ASIGNA
\where
resultado! = asignaFallido
\end{schema}
\end{itemize} 

Se definen estos esquemas con anterioridad ya que serán utilizados posteriormente en la definición de las operaciones del sistema.

\subsection{Bodegaje y entrega al comprador}

En la fase de bodegaje y entrega al comprador los paquetes inicialmente se encuentran en la bodega, el objetivo final de la empresa de logística y mensajería es entregar el paquete al comprador, para ello debe de fijar una ruta y asignar el paquete a un mensajero, los paquetes que aun están en la bodega y los que ya fueron puestos en ruta están pendientes de entregar a la persona(comprador) al cual pertenecen.

\begin{schema}{EntregaPaquete}
enBodega, enRuta, pendienteEntrega, entregado : \power Paquete\\
comprador : \power Cliente\\ 
mensajero : \power Empleado\\
pertenece : Paquete \pfun Cliente\\
asignado : Paquete \pfun Empleado
\where
\disjoint \langle pendienteEntrega, entregado \rangle\\
\langle enBodega, enRuta\rangle \partition pendienteEntrega \\
pendienteEntrega = \dom pertenece \\
enRuta = \dom asignado\\
mensajero = \ran asignado\\
comprador = \ran pertenece
\end{schema}

\subsection{Estado inicial}

Inicialmente los paquetes se encuentran en la bodega, no han sido asignados a un mensajero por lo tanto no están asociados a ninguna ruta. El total de paquetes por entregar es igual al de los paquetes que se encuentran en la bodega y el total de entregados corresponde a 0. El comprador esta definido en el rango de la función pertenece, el mensajero no puede ser especificado ya que aun no esta definido el rango de la función asignado.

\begin{schema}{InitEntregaPaquete}
EntregaPaquete'\\
pertenece? : Paquete \pfun Cliente
\where
pertenece' = pertenece?\\
enBodega' = \dom pertenece'\\
enRuta' = \emptyset\\
entregado' = \emptyset\\
comprador' = \ran pertenece'\\
pendienteEntrega' = enBodega'
\end{schema}

\subsection{Operaciones}

En esta sección se provee la especificación formal de las operaciones que se implementaran en el modulo de \textit{Bodegaje y entrega al comprador}. Se introducen también algunos diagramas de Venn con la intención de que permitan apreciar con mayor claridad de el estado de los paquetes luego de que una o varias operaciones son ejecutadas.

\subsubsection{Consultar paquete}

Se comprueba que existen paquetes pendientes de entrega en la bodega y que los paquetes requeridos se encuentran actualmente almacenados.

\begin{schema}{ConsultarPaquete}
\Xi EntregaPaquete\\
p? : Paquete\\
r! : Respuesta
\where
enBodega \neq \emptyset\\
p? \in enBodega\\
r! = paqueteDisponibleParaEntrega
\end{schema}

\subsubsection{Desalmacenar paquete y asignar a ruta.}

La operación \textit{DesalmacenarAsignarRuta} permite tomar los paquetes de la bodega y procesarlos. Una vez que los paquetes son tomados de la bodega estos deben ser asignados al mensajero que cubre la ruta que incluye las direcciones de entrega de dichos paquetes, los paquetes pasan a estar en ruta y el mensajero es parte del rango de la función \textit{asignado}.\\
\indent La Figura 3 ilustra el estado de los paquetes previo a la ejecución de esta operación. 

\newpage

\begin{figure}[h]
\centering
\begin{tikzpicture}

    \node at (6.72,4.75) {Paquete};

    \draw  (-2.5,-1.5)  rectangle (7.5,4.5);

    \draw[fill=gray!30] (0.7,1.5) ellipse (3cm and 2.5cm);
    \draw[fill=white] (1.8,1) ellipse (0.75cm and 1.25cm);
    \draw[fill=white] (-0.3,1) ellipse (1cm and 1.5cm);
    
    \draw[] (5.7,1.5) ellipse (1.5cm and 2cm);    
    
    \node at (5.7,2.5) {entregado};
    \node at (0.5,3) {pendienteEntrega};
    \node at (-0.27,1.3) {enBodega};
    \node at (1.8,1.5) {enRuta};
    
    \draw [fill] (0.2,2) circle [radius=1.5pt];
    \draw [fill] (-1,0.75) circle [radius=1.5pt];
    \draw [fill] (-0.75,0.5) circle [radius=1.5pt];
    \draw [fill] (-0.5,1) circle [radius=1.5pt];
    \draw [fill] (-0.5,-0.15) circle [radius=1.5pt];
    \draw [fill] (0,0.5) circle [radius=1.5pt];

	\draw [fill, green] (2,4.2) circle [radius=1.5pt];
    \draw [fill, green] (-2,3.8) circle [radius=1.5pt];
    \draw [fill, green] (-2,-1.2) circle [radius=1.5pt];
    \draw [fill, green] (-1.5,-1) circle [radius=1.5pt];
    \draw [fill, green] (-1.5,3.5) circle [radius=1.5pt];    
    
\end{tikzpicture}
\caption{\textit{Estado previo}} \label{fig:M1}
\end{figure}

\indent El resultado de esta operación esta vinculado a la disponibilidad de los mensajeros y puede arrojar dos resultados diferentes. En este punto es que toman relevancia las respuestas definidas en la sección \textit{Disponibilidad y asignación de mensajeros}.

\[ RDesalmacenarAsignarRuta \defs\\ 
\t3 (DesalmacenarAsignarRutaOK \wedge MensajeroDisponible)\\ 
\t3 \lor (DesalmacenarAsignarRutaFallida \wedge MensajeroNoDisponible) \]

La operación garantiza ser robusta ya que se combina con la especificación \textit{ASIGNA}. Los dos resultados posibles son:
\begin{enumerate}
\item La operación concluye satisfactoriamente.

\begin{schema}{DesalmacenarAsignarRutaOK}
\Delta EntregaPaquete\\
p? : Paquete\\
m? : Empleado\\
r! : ASIGNA
\where
p? \in enBodega\\
p? \notin  enRuta\\
m? \in mensajero \setminus \{\ran asignado\}\\
enBodega' = enBodega \setminus \{p?\}\\
enRuta' = enRuta \cup \{p?\}\\
asignado' = asignado \cup \{p? \mapsto m?\}
\end{schema}

Luego de ejecutar la operación \textit{DesalmacenarAsignarRutaOK} la clase \textit{EntregaPaquete} ha sido modificada por el movimiento de paquetes, el estado del sistema se puede apreciar en el siguiente diagrama.

\begin{figure}[h]
\centering
\begin{tikzpicture}

    \node at (6.72,4.75) {Paquete};

    \draw  (-2.5,-1.5)  rectangle (7.5,4.5);

    \draw[fill=gray!30] (0.7,1.5) ellipse (3cm and 2.5cm);
    \draw[fill=white] (1.8,1) ellipse (0.75cm and 1.25cm);
    \draw[fill=white] (-0.3,1) ellipse (1cm and 1.5cm);
    
    \draw[] (5.7,1.5) ellipse (1.5cm and 2cm);    
    
    \node at (5.7,2.5) {entregado};
    \node at (0.5,3) {pendienteEntrega};
    \node at (-0.27,1.3) {enBodega};
    \node at (1.8,1.5) {enRuta};
    
    \draw [fill] (0.2,2) circle [radius=1.5pt];
    \draw [fill] (-1,0.75) circle [radius=1.5pt];
    \draw [fill] (-0.75,0.5) circle [radius=1.5pt];
    \draw [fill] (-0.5,1) circle [radius=1.5pt];
    \draw [fill] (-0.5,-0.15) circle [radius=1.5pt];

	\draw [fill, green] (2,4.2) circle [radius=1.5pt];
    \draw [fill, green] (-2,3.8) circle [radius=1.5pt];
    \draw [fill, green] (-2,-1.2) circle [radius=1.5pt];
    \draw [fill, green] (-1.5,-1) circle [radius=1.5pt];
    \draw [fill, green] (-1.5,3.5) circle [radius=1.5pt];       
    
    \draw [fill, blue] (2,0.5) circle [radius=1.5pt]; 
    \draw[{Circle[red]}-Latex] (0,0.5) -- (1.9,0.5);
    
\end{tikzpicture}
\caption{\textit{Desalmacenaje y asignación a ruta}} \label{fig:M1}
\end{figure}
Dentro del universo de paquetes los puntos de color verde representan los paquetes que aun no han sido ingresados a la bodega. Los puntos de color negro son los paquetes que están actualmente en la bodega. La acción realizada por la operación \textit{DesalmacenarAsignarRutaOK} esta representada por el punto de color rojo y el movimiento que lo convierte en un paquete en ruta indicado por la flecha y el punto de color azul.

\item El paquete no se pudo asignar a un mensajero.

\begin{schema}{DesalmacenarAsignarRutaFallida}
\Xi EntregaPaquete\\
p? : Paquete\\
m? : Empleado\\
r! : ASIGNA
\where
p? \in enBodega\\
p? \notin  enRuta\\
m? \in mensajero\\
enBodega' = enBodega\\
enRuta' = enRuta\\
asignado' = asignado
\end{schema}
\end{enumerate}

En este escenario el estado del sistema es igual al estado previo (ver Figura 3) ya que la operación no concluyo satisfactoriamente. Preservar este estado es importante ya que esto permite que el paquete este disponible de nuevo para ser asignado y puesto en ruta en intentos subsiguientes.

\subsubsection{Entrega del paquete al comprador.}
Una vez que el paquete ha sido asignado a un mensajero y por ende puesto en ruta el mensajero se dirige a la dirección de entrega para intentar hacer efectivo el recibo por parte del comprador. Los dos posibles escenarios que el sistema maneja son:

\begin{enumerate}
\item El comprador se encuentra en la dirección de entrega y recibe el paquete.

%\begin{schema}{EntregarPaqueteOK}
%\Xi EntregaPaquete\\
%p? : Paquete\\
%m? : Empleado\\
%r! : ASIGNA
%\where
%p? \in enBodega\\
%p? \notin  enRuta\\
%m? \in mensajero'\\
%enBodega' = enBodega \setminus \{p?\}\\
%enRuta' = enRuta \cup \{p?\}\\
%asignado' = asignado \cup \{p? \mapsto m?\}
%\end{schema}

\item El comprador no esta disponible para la recepción del paquete.

%\begin{schema}{EtregarPaqueteFallido}
%\Xi EntregaPaquete\\
%p? : Paquete\\
%m? : Empleado\\
%r! : ASIGNA
%\where
%p? \in enBodega\\
%p? \notin  enRuta\\
%m? \in mensajero'\\
%enBodega' = enBodega \setminus \{p?\}\\
%enRuta' = enRuta \cup \{p?\}\\
%asignado' = asignado \cup \{p? \mapsto m?\}
%\end{schema}

\end{enumerate}

\subsubsection{Regresar paquete a bodega.}
Cuando la entrega del paquete al comprador no concluyo de manera satisfactoria, dicho paquete debe ser de nuevo llevado a la bodega, esta operación modifica el estado del sistema ya que existe un movimiento del paquete (salida de los paquetes que están en ruta y el reingreso a los que están en bodega), también el paquete es desasignado del mensajero. Esta operación preserva la consistencia en el estado del sistema permitiendo que el paquete pueda ser procesado de nuevo en intentos subsiguientes.

%\begin{schema}{RegresarBodega}
%\Xi EntregaPaquete\\
%p? : Paquete\\
%m? : Empleado\\
%r! : ASIGNA
%\where
%p? \in enBodega\\
%p? \notin  enRuta\\
%m? \in mensajero'\\
%enBodega' = enBodega \setminus \{p?\}\\
%enRuta' = enRuta \cup \{p?\}\\
%asignado' = asignado \cup \{p? \mapsto m?\}
%\end{schema}

\subsection{Interfaz de usuario.}

\section{Resumen de entradas, salidas y respuestas.}

\section{Trabajos futuros.}
Tanto en el resumen inicial como en la definición del problema se establece que el alcance de este trabajo se limita a un subproceso que forma parte de un sistema mas complejo que envuelve todos los aspectos necesarios para que una compra realizada en el exterior llegue de forma adecuada al comprador.\\[\baselineskip]
\indent Las posibilidades de trabajos futuros referentes a este tema se pueden abordar tanto desde mejoras a lo que acá se ha presentado, así como, en modelar y formalizar los subprocesos que, fueron mencionados brevemente en el resumen inicial y que anteceden o preceden al flujo desarrollado por los autores de este trabajo.


\newpage
\begin{thebibliography}{00}
\bibitem{b0} Software Development with Z, J.B. Wordsworth, IBM UK Labs Ltd. First Printed 1992
\bibitem{b1} The Z notation: A reference Manual, J.M . Spivey, 2nd Edition, 1998.
\bibitem{b2} Ingeniería de Software, Referencias varias, Prof.Ignacio Trejos Zelaya, ITCR.2014. \url{https://tecdigital.tec.ac.cr/dotlrn/classes/MC/MC7204/S-2-2018.SJ.MC7204.40/file-storage/#/58119055}
\bibitem{b3} Fuzz Manual, J.M. Spivey, 2nd Edition, Oxford, England, 2000.
%\bibitem{b4} Instalación de Fuzz, verificador de Z en MacOS, Christopher Jiménez, ITCR, 2018 URL \url{https://tecdigital.tec.ac.cr/dotlrn/classes/MC/MC7204/S-2-2018.SJ.MC7204.40/file-storage/#/59221405}
\end{thebibliography}

\end{document}